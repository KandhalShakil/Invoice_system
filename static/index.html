<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shakil's Grocery Shop - MongoDB Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
        }

        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 3px solid #ff9933;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff9933, #ffffff, #138808);
            animation: slideBar 3s linear infinite;
        }

        @keyframes slideBar {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .header h1 {
            color: #138808;
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            color: #ff9933;
            font-size: 1.4em;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            border: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 18px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.4s ease;
            margin: 0 3px;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,153,51,0.2), transparent);
            transition: left 0.5s;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab:hover {
            background: rgba(255, 153, 51, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 153, 51, 0.3);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #138808 0%, #28a745 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(19, 136, 8, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff9933 0%, #ffffff 50%, #138808 100%);
        }

        .card h2 {
            color: #138808;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
            border-bottom: 3px solid #ff9933;
            padding-bottom: 12px;
            display: inline-block;
            position: relative;
        }
        
        .card h2::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 50%;
            height: 3px;
            background: #138808;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1.1em;
            transition: all 0.3s ease;
            background: #ffffff;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #138808;
            box-shadow: 0 0 0 3px rgba(19, 136, 8, 0.1), inset 0 2px 4px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 4px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: auto;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
                margin: 2px 0;
            }
        }
        
        @media (max-width: 480px) {
            .btn {
                padding: 10px 16px;
                font-size: 0.85em;
                margin: 2px;
            }
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transition: width 0.6s, height 0.6s;
            transform: translate(-50%, -50%);
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0069d9 0%, #004494 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #138808 0%, #28a745 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #0f6606 0%, #218838 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(19, 136, 8, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9933 0%, #e67e22 100%);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 153, 51, 0.4);
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        th, td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: linear-gradient(135deg, #138808 0%, #28a745 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.95em;
        }
        
        th:last-child, td:last-child {
            text-align: center;
        }

        tbody tr {
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: linear-gradient(135deg, rgba(19, 136, 8, 0.05) 0%, rgba(255, 153, 51, 0.05) 100%);
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid #e9ecef;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff9933, #138808);
            transition: left 0.5s ease;
        }
        
        .stat-card:hover::before {
            left: 0;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 30px rgba(19, 136, 8, 0.2);
            border-color: #138808;
        }

        .stat-card h3 {
            color: #138808;
            font-size: 2.5em;
            margin: 15px 0;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card p {
            color: #ff9933;
            font-size: 1.1em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(19,136,8,0.1), transparent);
            transition: left 0.8s ease;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 35px rgba(19, 136, 8, 0.2);
        }

        .stat-card h3 {
            color: #138808;
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .stat-card p {
            color: #ff9933;
            font-size: 1.3em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .invoice-items {
            margin: 20px 0;
        }
        
        .invoice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }        .invoice-summary {
            background: #34495e;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .invoice-summary .row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .invoice-summary .total {
            font-size: 1.3em;
            font-weight: bold;
            border-top: 1px solid #fff;
            padding-top: 10px;
        }

        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-bar input {
            flex: 1;
            min-width: 250px;
            padding: 14px 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }
        
        .search-bar input:focus {
            outline: none;
            border-color: #138808;
            box-shadow: 0 0 0 3px rgba(19, 136, 8, 0.1);
        }
        
        .search-bar button {
            min-width: 120px;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }

            .invoice-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: #6c757d;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            border: 2px dashed #dee2e6;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            color: #138808;
            font-size: 1.8em;
            font-weight: 600;
        }
        
        .empty-state p {
            font-size: 1.1em;
            color: #6c757d;
        }

        /* Enhanced Popup Modal Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 153, 51, 0.1) 0%, rgba(19, 136, 8, 0.1) 50%, rgba(255, 255, 255, 0.1) 100%);
            backdrop-filter: blur(8px) saturate(150%);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }
        
        .popup-modal {
            background: #ffffff;
            padding: 35px 40px;
            border-radius: 20px;
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            max-width: 600px;
            width: 95%;
            max-height: 85vh;
            text-align: center;
            transform: scale(0.8) translateY(30px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .popup-modal::-webkit-scrollbar {
            width: 8px;
        }
        
        .popup-modal::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .popup-modal::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #ff9933, #138808);
            border-radius: 10px;
        }
        
        .popup-modal::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #138808, #ff9933);
        }
        
        .popup-modal::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #FF9933, #FFFFFF, #138808, #FF9933);
            background-size: 300% 300%;
            border-radius: 22px;
            z-index: -1;
            animation: gradientBorder 3s ease infinite;
        }
        
        @keyframes gradientBorder {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .popup-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        
        .popup-overlay.show .popup-modal {
            transform: scale(1) translateY(0);
        }
        
        .popup-overlay.hide {
            animation: fadeOut 0.2s ease-in;
        }
        
        .popup-overlay.hide .popup-modal {
            transform: scale(0.9) translateY(20px);
            opacity: 0;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .popup-modal h3 {
            color: #FF9933;
            margin-bottom: 20px;
            font-size: 1.6em;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(255, 153, 51, 0.3);
            position: relative;
            padding-bottom: 15px;
        }
        
        .popup-modal h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #FF9933, #138808);
            border-radius: 2px;
        }
        
        .popup-modal p {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 1.15em;
            line-height: 1.6;
            font-weight: 500;
            text-align: center;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .popup-modal input,
        .popup-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1.1em;
            margin-bottom: 25px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .popup-modal input:focus,
        .popup-input:focus {
            outline: none;
            border-color: #FF9933;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(255, 153, 51, 0.1), inset 0 2px 4px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }
        
        .popup-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .popup-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.05em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 120px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .popup-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .popup-btn:hover::before {
            left: 100%;
        }
        
        .popup-btn.confirm {
            background: linear-gradient(135deg, #FF9933 0%, #FF6B35 50%, #E8751A 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(255, 153, 51, 0.3);
        }
        
        .popup-btn.confirm:hover {
            background: linear-gradient(135deg, #FF8C1A 0%, #FF5722 50%, #D84315 100%);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 153, 51, 0.4);
        }
        
        .popup-btn.confirm:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 4px 15px rgba(255, 153, 51, 0.3);
        }
        
        .popup-btn.cancel {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 50%, #495057 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.2);
        }
        
        .popup-btn.cancel:hover {
            background: linear-gradient(135deg, #5a6268 0%, #495057 50%, #343a40 100%);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }
        
        .popup-btn.cancel:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.2);
        }
        
        .popup-btn.ok {
            background: linear-gradient(135deg, #138808 0%, #28a745 50%, #20c997 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(19, 136, 8, 0.3);
        }
        
        .popup-btn.ok:hover {
            background: linear-gradient(135deg, #0f6808 0%, #218838 50%, #1e7e34 100%);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(19, 136, 8, 0.4);
        }
        
        .popup-btn.ok:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 4px 15px rgba(19, 136, 8, 0.3);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-tab {
                min-width: auto;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .popup-modal {
                margin: 20px;
                padding: 25px 30px;
                max-width: none;
                width: auto;
            }
            
            .popup-modal h3 {
                font-size: 1.4em;
            }
            
            .popup-modal p {
                font-size: 1.1em;
            }
            
            .popup-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .popup-btn {
                width: 100%;
                padding: 12px 20px;
                font-size: 1em;
            }
            
            .invoice-item {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            table {
                font-size: 0.9em;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 20px;
            }
            
            .popup-modal {
                margin: 15px;
                padding: 20px 25px;
            }
            
            .popup-modal h3 {
                font-size: 1.3em;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 1em;
            }
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            animation: slideInRight 0.4s ease-out;
            max-width: 400px;
            border-left: 4px solid #138808;
        }
        
        .notification.success {
            border-left-color: #138808;
        }
        
        .notification.error {
            border-left-color: #dc3545;
        }
        
        .notification.warning {
            border-left-color: #ff9933;
        }
        
        .notification-icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: bold;
            margin-bottom: 3px;
            color: #2c3e50;
        }
        
        .notification-message {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .notification-close:hover {
            background: #f8f9fa;
            color: #2c3e50;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .notification.hiding {
            animation: slideOutRight 0.4s ease-out forwards;
        }
        
        @media (max-width: 768px) {
            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" id="mainHeader">
            <h1 id="shopNameHeader">üè™ Loading...</h1>
            <p>MongoDB-Powered Invoice Management System</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard', this)">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('items', this)">üì¶ Items</button>
            <button class="nav-tab" onclick="showTab('customers', this)">üë• Customers</button>
            <button class="nav-tab" onclick="showTab('invoice', this)">üßæ Create Invoice</button>
            <button class="nav-tab" onclick="showTab('invoices', this)">üìã View Invoices</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #138808;" >üìä Business Overview</h2>
                <button onclick="exportAllData()" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 8px;">
                    üì• Export All Data
                </button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalInvoices">-</h3>
                    <p>Total Invoices</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalRevenue">-</h3>
                    <p>Total Revenue</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalItems">-</h3>
                    <p>Items in Stock</p>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showLowStockItems()">
                    <h3 id="lowStockItems" style="color: #dc3545;">-</h3>
                    <p>‚ö†Ô∏è Low Stock Alert</p>
                </div>
            </div>

            <div class="card">
                <h2>üìà Top Customers</h2>
                <div id="topCustomers" class="loading">Loading...</div>
            </div>

            <div class="card">
                <h2>üìÖ Recent Sales</h2>
                <div id="recentSales" class="loading">Loading...</div>
            </div>
        </div>

        <!-- Items Tab -->
        <div id="items" class="tab-content">
            <div class="card">
                <h2>‚ûï Add New Item</h2>
                <form id="addItemForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 25px;">
                        <div class="form-group">
                            <label>üì¶ Item Name</label>
                            <input type="text" id="itemName" placeholder="Enter item name" required>
                        </div>
                        <div class="form-group">
                            <label>üí∞ Price (‚Çπ)</label>
                            <input type="number" step="0.01" id="itemPrice" placeholder="Enter price in rupees" required>
                        </div>
                        <div class="form-group">
                            <label>üìä Stock Quantity</label>
                            <input type="number" id="itemStock" placeholder="Enter stock quantity" required>
                        </div>
                        <div class="form-group">
                            <label>üìè Unit</label>
                            <select id="itemUnit" required style="padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1.1em; background: #f8f9fa;">
                                <option value="">Select Unit</option>
                                <option value="kg">Kilogram (kg)</option>
                                <option value="gm">Gram (gm)</option>
                                <option value="l">Liter (l)</option>
                                <option value="ml">Milliliter (ml)</option>
                                <option value="pcs">Pieces (pcs)</option>
                                <option value="pack">Pack</option>
                                <option value="box">Box</option>
                                <option value="bottle">Bottle</option>
                                <option value="bag">Bag</option>
                                <option value="dozen">Dozen</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Add Item</button>
                </form>
            </div>

            <div class="card">
                <h2>üì¶ Inventory Management</h2>
                <div class="search-bar">
                    <input type="text" id="itemSearch" placeholder="Search items...">
                    <button onclick="searchItems()" class="btn btn-primary">Search</button>
                    <button onclick="loadItems()" class="btn btn-warning">Show All</button>
                </div>
                <div id="itemsTable" class="loading">Loading items...</div>
            </div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="tab-content">
            <div class="card">
                <h2>‚ûï Add New Customer</h2>
                <form id="addCustomerForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                        <div class="form-group">
                            <label>üë§ Customer Name</label>
                            <input type="text" id="newCustomerName" placeholder="Enter full name" required>
                        </div>
                        <div class="form-group">
                            <label>üì± Phone Number</label>
                            <input type="tel" id="newCustomerPhone" placeholder="+91 XXXXX XXXXX" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                        <div class="form-group">
                            <label>üìß Email</label>
                            <input type="email" id="newCustomerEmail" placeholder="customer@example.com" required>
                        </div>
                        <div class="form-group">
                            <label>üè† Address</label>
                            <textarea id="newCustomerAddress" rows="1" placeholder="Enter complete address" required style="padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1.1em; background: #f8f9fa; resize: vertical;"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Add Customer</button>
                </form>
            </div>

            <div class="card">
                <h2>üë• Customer Directory</h2>
                <div class="search-bar">
                    <input type="text" id="customerSearch" placeholder="Search customers by name or phone...">
                    <button onclick="searchCustomers()" class="btn btn-primary">Search</button>
                    <button onclick="loadCustomers()" class="btn btn-warning">Show All</button>
                </div>
                <div id="customersTable" class="loading">Loading customers...</div>
            </div>
        </div>

        <!-- Create Invoice Tab -->
        <div id="invoice" class="tab-content">
            <div class="card">
                <h2>üë§ Customer Information</h2>
                
                <!-- Customer Selection Dropdown -->
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="font-size: 1.1em; font-weight: bold;">üîç Select Existing Customer</label>
                    <select id="customerSelect" style="padding: 15px; border: 2px solid #138808; border-radius: 10px; font-size: 1.1em; background: #f8f9fa; width: 100%;">
                        <option value="">-- Select a customer or enter new details below --</option>
                    </select>
                </div>
                
                <div style="text-align: center; margin: 20px 0; color: #666; font-weight: bold;">
                    OR Enter New Customer Details
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                    <div class="form-group">
                        <label>üë§ Customer Name</label>
                        <input type="text" id="customerName" placeholder="Enter customer full name" required>
                    </div>
                    <div class="form-group">
                        <label>üì± Customer Phone</label>
                        <input type="tel" id="customerPhone" placeholder="+91 XXXXX XXXXX" pattern="[+][0-9]{2}[0-9]{5}[0-9]{5}" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>üìß Customer Email</label>
                    <input type="email" id="customerEmail" placeholder="customer@example.com (for sending invoice)" required>
                </div>
                <div class="form-group">
                    <label>üè† Customer Address</label>
                    <textarea id="customerAddress" rows="3" placeholder="Enter complete address with city and state" required></textarea>
                </div>
            </div>

            <div class="card">
                <h2>üõí Add Items to Invoice</h2>
                
                <!-- QR Scanner Button -->
                <div style="margin-bottom: 20px; text-align: center;">
                    <button onclick="openQRScanner()" class="btn btn-success" style="font-size: 1.2em; padding: 15px 30px;">
                        üì∑ Scan Item QR Code
                    </button>
                    <p style="color: #666; margin-top: 10px; font-size: 0.9em;">Or manually select item below</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 20px; align-items: end; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 15px; border: 2px dashed #138808;">
                    <div class="form-group">
                        <label>üõçÔ∏è Select Item</label>
                        <select id="invoiceItemSelect" style="background: #ffffff; border: 2px solid #138808;">
                            <option value="">Choose an item...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üî¢ Quantity</label>
                        <input type="number" id="invoiceQuantity" min="1" value="1" style="text-align: center; font-weight: bold; border: 2px solid #138808;">
                    </div>
                    <div class="form-group">
                        <label>üì¶ Available Stock</label>
                        <input type="number" id="availableStock" readonly style="background: #f8f9fa; text-align: center; font-weight: bold; border: 2px solid #6c757d;">
                    </div>
                    <div class="form-group">
                        <button onclick="addItemToInvoice()" class="btn btn-success" style="padding: 16px 24px; font-size: 1.2em;">‚ûï Add Item</button>
                    </div>
                </div>

                <div class="invoice-items">
                    <h3>Invoice Items</h3>
                    <div id="invoiceItemsList"></div>
                </div>

                <div id="invoiceSummary" class="invoice-summary" style="display: none;">
                    <div class="row">
                        <span>Subtotal:</span>
                        <span id="subtotal">Rs. 0.00</span>
                    </div>
                    <div class="row">
                        <label for="taxRate" style="display:flex; gap:8px; align-items:center; width:100%;">
                            <span>Tax (%)</span>
                            <input type="number" id="taxRate" value="0" min="0" step="0.01" style="width:120px; text-align:right; border:2px solid #138808; border-radius:8px; padding:6px 10px; font-weight:bold;">
                        </label>
                        <span id="tax">Rs. 0.00</span>
                    </div>
                    <div class="row">
                        <label for="discountRate" style="display:flex; gap:8px; align-items:center; width:100%;">
                            <span>Discount (%)</span>
                            <input type="number" id="discountRate" value="0" min="0" step="0.01" style="width:120px; text-align:right; border:2px solid #dc3545; border-radius:8px; padding:6px 10px; font-weight:bold;">
                        </label>
                        <span id="discount">Rs. 0.00</span>
                    </div>
                    <div class="row total">
                        <span>Total:</span>
                        <span id="total">Rs. 0.00</span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; border: 2px solid #007bff;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="sendEmailCheckbox" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-size: 1.1em; font-weight: 600; color: #007bff;">üìß Send invoice to customer's email</span>
                        </label>
                        <p style="margin: 10px 0 0 30px; color: #666; font-size: 0.9em;">
                            ‚úâÔ∏è Customer will receive a detailed invoice via email
                        </p>
                    </div>
                    <div style="background: #d4edda; padding: 20px; border-radius: 10px; border: 2px solid #28a745;">
                        <label style="font-size: 1.1em; font-weight: 600; color: #28a745; margin-bottom: 10px; display: block;">üí≥ Payment Method</label>
                        <select id="paymentMethod" style="width: 100%; padding: 12px; border: 2px solid #28a745; border-radius: 8px; font-size: 1em; background: white;">
                            <option value="cash">üíµ Cash</option>
                            <option value="card">üí≥ Card</option>
                            <option value="upi">üì± UPI</option>
                            <option value="bank_transfer">üè¶ Bank Transfer</option>
                            <option value="cheque">üìù Cheque</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>üìù Additional Notes (Optional)</label>
                    <textarea id="invoiceNotes" rows="2" placeholder="Add any special instructions or notes for this invoice..." style="padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1em; background: #f8f9fa; resize: vertical; width: 100%;"></textarea>
                </div>

                <button onclick="generateInvoice()" class="btn btn-primary" style="margin-top: 20px;" disabled id="generateBtn">Generate Invoice</button>
            </div>
        </div>

        <!-- View Invoices Tab -->
        <div id="invoices" class="tab-content">
            <div class="card">
                <h2>üìã All Invoices</h2>
                <div class="search-bar">
                    <input type="text" id="invoiceSearch" placeholder="Search by customer name or invoice ID...">
                    <button onclick="searchInvoices()" class="btn btn-primary">Search</button>
                    <button onclick="loadInvoices()" class="btn btn-warning">Show All</button>
                </div>
                <div id="invoicesTable" class="loading">Loading invoices...</div>
            </div>
        </div>

        <!-- Alert container -->
        <div id="alertContainer"></div>
    </div>

    <!-- Custom Popup Modal -->
    <div id="popupOverlay" class="popup-overlay">
        <div class="popup-modal">
            <h3 id="popupTitle">Confirmation</h3>
            <p id="popupMessage">Are you sure?</p>
            <div class="popup-buttons" id="popupButtons">
                <button class="popup-btn cancel" onclick="hidePopup()">Cancel</button>
                <button class="popup-btn confirm" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- QR Code Display Modal -->
    <div id="qrModal" class="popup-overlay" style="display:none;">
        <div class="popup-modal" style="max-width: 500px;">
            <h3 id="qrModalTitle">üì± Item QR Code</h3>
            <div id="qrModalContent" style="text-align: center; padding: 20px;">
                <img id="qrCodeImage" src="" alt="QR Code" style="max-width: 300px; border: 3px solid #138808; border-radius: 10px; padding: 10px; background: white;">
                <p id="qrItemInfo" style="margin-top: 15px; font-weight: bold; color: #138808;"></p>
                <p style="color: #666; margin-top: 10px; font-size: 0.9em;">Scan this QR code to quickly add item to invoice</p>
            </div>
            <div class="popup-buttons">
                <button class="popup-btn ok" onclick="printQR()">üñ®Ô∏è Print QR</button>
                <button class="popup-btn cancel" onclick="closeQRModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- QR Scanner Modal -->
    <div id="qrScannerModal" class="popup-overlay" style="display:none;">
        <div class="popup-modal" style="max-width: 600px;">
            <h3>üì∑ Scan Item QR Code</h3>
            <div style="padding: 20px;">
                <video id="qrVideo" style="width: 100%; max-width: 500px; border: 3px solid #138808; border-radius: 10px;"></video>
                <canvas id="qrCanvas" style="display:none;"></canvas>
                <p style="margin-top: 15px; text-align: center; color: #666;">Position the QR code within the camera frame</p>
            </div>
            <div class="popup-buttons">
                <button class="popup-btn cancel" onclick="closeQRScanner()">Close Scanner</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        const API_BASE = 'http://127.0.0.1:5000';
        let currentItems = [];
        let invoiceItems = [];
        let popupCallback = null;
        
        // Helper function to get auth headers
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('session_token')}`
            };
        }
        
        // Helper function to handle auth errors
        function handleAuthError(data) {
            if (data.error && (data.error.includes('Unauthorized') || data.error.includes('login'))) {
                showPopup('Session Expired ‚ö†Ô∏è', 'Your session has expired. Please login again.', 'alert');
                setTimeout(() => {
                    localStorage.clear();
                    window.location.href = 'login.html';
                }, 2000);
                return true;
            }
            return false;
        }
        
        // Check authentication on page load
        async function checkAuth() {
            const sessionToken = localStorage.getItem('session_token');
            
            if (!sessionToken) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/verify-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ session_token: sessionToken })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('user_email');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Update UI with user email
                const userEmail = localStorage.getItem('user_email');
                const shopName = localStorage.getItem('shop_name') || data.shop_name || 'Shop';
                const shopAddress = localStorage.getItem('shop_address') || data.shop_address || '';
                const shopPhone = localStorage.getItem('shop_phone') || data.shop_phone || '';
                
                // Update shop name in header
                document.getElementById('shopNameHeader').textContent = `üè™ ${shopName}`;
                document.title = `${shopName} - Invoice System`;
                
                // Store shop details if from API
                if (data.shop_name) {
                    localStorage.setItem('shop_name', data.shop_name);
                    localStorage.setItem('shop_address', data.shop_address);
                    localStorage.setItem('shop_phone', data.shop_phone);
                }
                
                if (userEmail) {
                    updateHeaderWithUser(userEmail);
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'login.html';
            }
        }
        
        function updateHeaderWithUser(email) {
            const header = document.querySelector('.header');
            const logoutBtn = document.createElement('div');
            logoutBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 15px;';
            logoutBtn.innerHTML = `
                <span style="color: #138808; font-weight: 600; font-size: 0.95em;">üë§ ${email}</span>
                <button onclick="logout()" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                    üö™ Logout
                </button>
            `;
            header.style.position = 'relative';
            header.appendChild(logoutBtn);
        }
        
        async function logout() {
            const sessionToken = localStorage.getItem('session_token');
            
            try {
                await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ session_token: sessionToken })
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('session_token');
            localStorage.removeItem('user_email');
            localStorage.removeItem('shop_name');
            localStorage.removeItem('shop_address');
            localStorage.removeItem('shop_phone');
            window.location.href = 'login.html';
        }
        
        // Run auth check immediately
        checkAuth();
        
        // Popup Functions
        function showPopup(title, message, type = 'confirm', callback = null) {
            document.getElementById('popupTitle').textContent = title;
            document.getElementById('popupMessage').innerHTML = message;
            popupCallback = callback;
            
            const buttonsDiv = document.getElementById('popupButtons');
            if (type === 'confirm') {
                buttonsDiv.innerHTML = `
                    <button class="popup-btn cancel" onclick="hidePopup()">Cancel</button>
                    <button class="popup-btn confirm" onclick="confirmAction()">Confirm</button>
                `;
            } else if (type === 'alert') {
                buttonsDiv.innerHTML = `
                    <button class="popup-btn ok" onclick="hidePopup()">OK</button>
                `;
            }
            
            const overlay = document.getElementById('popupOverlay');
            overlay.style.display = 'flex';
            overlay.classList.add('show');
            
            // Close on click outside modal
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    hidePopup();
                }
            };
            
            // Prevent modal click from closing
            overlay.querySelector('.popup-modal').onclick = function(e) {
                e.stopPropagation();
            };
            
            // Add keyboard support
            document.addEventListener('keydown', handlePopupKeydown);
        }
        
        function hidePopup() {
            const overlay = document.getElementById('popupOverlay');
            overlay.classList.add('hide');
            overlay.classList.remove('show');
            
            setTimeout(() => {
                overlay.style.display = 'none';
                overlay.classList.remove('hide');
                popupCallback = null;
            }, 200);
        }
        
        function confirmAction() {
            if (popupCallback) {
                popupCallback();
            }
            hidePopup();
        }
        
        // Input Popup for prompts
        function showInputPopup(title, message, inputType = 'text', placeholder = '', callback = null) {
            document.getElementById('popupTitle').textContent = title;
            document.getElementById('popupMessage').innerHTML = `
                <p style="margin-bottom: 20px;">${message}</p>
                <input type="${inputType}" id="popupInput" placeholder="${placeholder}" 
                       class="popup-input"
                       step="0.01" min="0">
            `;
            popupCallback = () => {
                const value = document.getElementById('popupInput').value;
                if (callback) callback(value);
            };
            
            const buttonsDiv = document.getElementById('popupButtons');
            buttonsDiv.innerHTML = `
                <button class="popup-btn cancel" onclick="hidePopup()">Cancel</button>
                <button class="popup-btn confirm" onclick="confirmAction()">Update</button>
            `;
            
            const overlay = document.getElementById('popupOverlay');
            overlay.style.display = 'flex';
            overlay.classList.add('show');
            
            // Close on click outside modal
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    hidePopup();
                }
            };
            
            // Prevent modal click from closing
            overlay.querySelector('.popup-modal').onclick = function(e) {
                e.stopPropagation();
            };
            
            // Add keyboard support
            document.addEventListener('keydown', handlePopupKeydown);
            
            // Focus on input and select text
            setTimeout(() => {
                const input = document.getElementById('popupInput');
                if (input) {
                    input.focus();
                    input.select();
                    
                    // Allow Enter key to confirm
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            confirmAction();
                        }
                    });
                }
            }, 100);
        }
        
        function handlePopupKeydown(e) {
            if (e.key === 'Escape' && document.getElementById('popupOverlay').classList.contains('show')) {
                hidePopup();
            }
        }
        
        // Notification System
        function showNotification(title, message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconMap = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            };
            
            notification.innerHTML = `
                <div class="notification-icon">${iconMap[type] || '‚úÖ'}</div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.classList.add('hiding');
                setTimeout(() => {
                    notification.remove();
                }, 400);
            }, 4000);
        }

        // Utility functions
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR'
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        // Tab management
        function showTab(tabName, element = null) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            if (element) {
                element.classList.add('active');
            } else if (event && event.target) {
                event.target.classList.add('active');
            }

            // Load data based on tab
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'items') {
                loadItems();
                loadItemsForInvoice();
            } else if (tabName === 'customers') {
                loadCustomers();
            } else if (tabName === 'invoice') {
                loadCustomersForInvoice();
                loadItemsForInvoice();
                clearInvoiceForm();
            } else if (tabName === 'invoices') {
                loadInvoices();
            }
        }

        // Dashboard functions
        async function loadDashboard() {
            try {
                const [statsResponse, itemsResponse] = await Promise.all([
                    fetch(`${API_BASE}/api/stats`, { headers: getAuthHeaders() }),
                    fetch(`${API_BASE}/api/items`, { headers: getAuthHeaders() })
                ]);

                const statsData = await statsResponse.json();
                const itemsData = await itemsResponse.json();

                if (handleAuthError(statsData) || handleAuthError(itemsData)) return;

                if (statsData.success) {
                    const stats = statsData.stats;
                    document.getElementById('totalInvoices').textContent = stats.total_invoices;
                    document.getElementById('totalRevenue').textContent = formatCurrency(stats.total_revenue);

                    // Top customers
                    const topCustomersDiv = document.getElementById('topCustomers');
                    if (stats.top_customers.length > 0) {
                        topCustomersDiv.innerHTML = stats.top_customers.map(customer => 
                            `<div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                                <span>${customer._id}</span>
                                <span>${formatCurrency(customer.total_spent)} (${customer.invoice_count} invoices)</span>
                            </div>`
                        ).join('');
                    } else {
                        topCustomersDiv.innerHTML = '<div class="empty-state"><h3>No customers yet</h3><p>Create your first invoice to see top customers</p></div>';
                    }

                    // Recent sales
                    const recentSalesDiv = document.getElementById('recentSales');
                    if (stats.daily_sales.length > 0) {
                        recentSalesDiv.innerHTML = stats.daily_sales.map(sale => 
                            `<div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                                <span>${formatDate(sale._id)}</span>
                                <span>${formatCurrency(sale.daily_sales)}</span>
                            </div>`
                        ).join('');
                    } else {
                        recentSalesDiv.innerHTML = '<div class="empty-state"><h3>No sales data</h3><p>Create invoices to see sales trends</p></div>';
                    }
                }

                if (itemsData.success) {
                    document.getElementById('totalItems').textContent = itemsData.items.length;
                    
                    // Calculate low stock items (stock <= 10)
                    const lowStockCount = itemsData.items.filter(item => item.stock <= 10).length;
                    document.getElementById('lowStockItems').textContent = lowStockCount;
                    
                    // Store low stock items for later use
                    window.lowStockItems = itemsData.items.filter(item => item.stock <= 10);
                }

            } catch (error) {
                console.error('Error loading dashboard:', error);
                showPopup('Error ‚ùå', 'Failed to load dashboard data. Please refresh the page.', 'alert');
            }
        }

        function showLowStockItems() {
            if (!window.lowStockItems || window.lowStockItems.length === 0) {
                showPopup('No Low Stock Items ‚úÖ', 'All items have sufficient stock!', 'alert');
                return;
            }
            
            const itemsList = window.lowStockItems
                .map(item => `<div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                    <span><strong>${item.item_name}</strong></span>
                    <span style="color: ${item.stock === 0 ? '#dc3545' : item.stock <= 5 ? '#ffc107' : '#ff9933'}; font-weight: bold;">
                        ${item.stock} ${item.unit || 'pcs'} ${item.stock === 0 ? '(OUT OF STOCK!)' : ''}
                    </span>
                </div>`)
                .join('');
            
            showPopup('‚ö†Ô∏è Low Stock Alert', `
                <div style="text-align: left; max-height: 400px; overflow-y: auto;">
                    <p style="margin-bottom: 15px; color: #666;">The following items need restocking:</p>
                    ${itemsList}
                </div>
            `, 'alert');
        }

        async function exportAllData() {
            try {
                showNotification('Exporting...', 'Preparing your shop data for export', 'info');
                
                const response = await fetch(`${API_BASE}/api/export/all-data`, {
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (handleAuthError(result)) return;
                
                if (result.success) {
                    const data = result.data;
                    
                    // Create a formatted JSON string
                    const jsonString = JSON.stringify(data, null, 2);
                    
                    // Create blob and download
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // Generate filename with shop name and date
                    const shopName = data.shop_info.shop_name.replace(/[^a-z0-9]/gi, '_');
                    const date = new Date().toISOString().split('T')[0];
                    a.download = `${shopName}_Complete_Data_${date}.json`;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // Show success with summary
                    const summary = `
                        <div style="text-align: left; line-height: 1.8;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <strong style="font-size: 1.3em; color: #138808;">‚úÖ Data Export Completed Successfully!</strong>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #138808; margin-bottom: 15px;">
                                <strong style="color: #138808; font-size: 1.1em;">üìä Export Summary</strong>
                                <div style="margin-top: 15px; font-size: 1.05em;">
                                    <div style="padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                                        üì¶ <strong>Total Items:</strong> <span style="color: #138808; font-weight: bold;">${data.summary.total_items}</span> items in inventory
                                    </div>
                                    <div style="padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                                        üí∞ <strong>Stock Value:</strong> <span style="color: #138808; font-weight: bold;">${formatCurrency(data.summary.total_stock_value)}</span>
                                    </div>
                                    <div style="padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                                        üë• <strong>Total Customers:</strong> <span style="color: #138808; font-weight: bold;">${data.summary.total_customers}</span> registered customers
                                    </div>
                                    <div style="padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                                        üßæ <strong>Total Invoices:</strong> <span style="color: #138808; font-weight: bold;">${data.summary.total_invoices}</span> invoices generated
                                    </div>
                                    <div style="padding: 8px 0;">
                                        üíµ <strong>Total Revenue:</strong> <span style="color: #138808; font-weight: bold; font-size: 1.15em;">${formatCurrency(data.summary.total_revenue)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 10px; border-left: 5px solid #007bff; margin-bottom: 15px;">
                                <strong style="color: #007bff; font-size: 1.05em;">üìÅ Downloaded File</strong>
                                <div style="margin-top: 10px; background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #007bff;">
                                    <code style="color: #333; font-size: 0.95em; word-break: break-all;">${shopName}_Complete_Data_${date}.json</code>
                                </div>
                            </div>
                            
                            <div style="background: #fff3cd; padding: 12px; border-radius: 8px; border-left: 5px solid #ffc107;">
                                <p style="color: #856404; font-size: 0.95em; margin: 0; line-height: 1.6;">
                                    <strong>‚ÑπÔ∏è About This Export:</strong><br>
                                    Your complete shop data has been successfully exported as a JSON file. This file contains all your items, customers, and invoice records. You can use this export for data backup, analysis, reporting, or migration to other systems.
                                </p>
                            </div>
                        </div>
                    `;
                    
                    showPopup('Data Export Complete! üì•', summary, 'alert');
                } else {
                    showPopup('Export Failed ‚ùå', 'Error exporting data: ' + result.error, 'alert');
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                showPopup('Export Failed ‚ùå', 'Failed to export shop data. Please try again.', 'alert');
            }
        }

        // Items functions
        async function loadItems() {
            try {
                const response = await fetch(`${API_BASE}/api/items`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (handleAuthError(data)) return;

                if (data.success) {
                    currentItems = data.items;
                    displayItems(data.items);
                } else {
                    showPopup('Error ‚ùå', 'Error loading items: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error loading items:', error);
                showPopup('Error ‚ùå', 'Failed to load items. Please refresh the page.', 'alert');
            }
        }

        function displayItems(items) {
            const itemsTable = document.getElementById('itemsTable');
            
            if (items.length === 0) {
                itemsTable.innerHTML = '<div class="empty-state"><h3>No items found</h3><p>Add some items to your inventory</p></div>';
                return;
            }

            itemsTable.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Unit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    <td><strong>${item.item_name}</strong></td>
                                    <td><strong style="color: #138808;">‚Çπ${item.item_price.toFixed(2)}</strong></td>
                                    <td><span style="padding: 4px 12px; background: ${item.stock > 10 ? '#d4edda' : item.stock > 0 ? '#fff3cd' : '#f8d7da'}; color: ${item.stock > 10 ? '#155724' : item.stock > 0 ? '#856404' : '#721c24'}; border-radius: 6px; font-weight: 600;">${item.stock}</span></td>
                                    <td><span style="padding: 4px 10px; background: #e9ecef; border-radius: 6px; font-weight: 500;">${item.unit || '-'}</span></td>
                                    <td>
                                        <div class="action-buttons">
                                            <button onclick="showItemQR('${item._id}')" class="btn btn-success" title="Show QR Code">üì±</button>
                                            <button onclick="updateItemStock('${item._id}', '${item.item_name}')" class="btn btn-warning" title="Update Stock">üì¶</button>
                                            <button onclick="updateItemPrice('${item._id}', '${item.item_name}')" class="btn btn-primary" title="Update Price">üí∞</button>
                                            <button onclick="deleteItem('${item._id}', '${item.item_name}')" class="btn btn-danger" title="Delete Item">üóëÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function searchItems() {
            const searchTerm = document.getElementById('itemSearch').value.trim();
            
            if (!searchTerm) {
                loadItems();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/items/search?q=${encodeURIComponent(searchTerm)}`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (handleAuthError(data)) return;

                if (data.success) {
                    displayItems(data.items);
                } else {
                    showPopup('Error ‚ùå', 'Error searching items: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error searching items:', error);
                showPopup('Error ‚ùå', 'Failed to search items. Please try again.', 'alert');
            }
        }

        document.getElementById('addItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const itemName = document.getElementById('itemName').value.trim();
            const itemPrice = parseFloat(document.getElementById('itemPrice').value);
            const itemStock = parseInt(document.getElementById('itemStock').value);
            const itemUnit = document.getElementById('itemUnit').value;

            if (!itemName || itemPrice < 0 || itemStock < 0 || !itemUnit) {
                showPopup('Invalid Input ‚ö†Ô∏è', 'Please fill in all fields with valid values. Price and stock must be positive numbers and unit must be selected.', 'alert');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/items`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        item_name: itemName,
                        item_price: itemPrice,
                        stock: itemStock,
                        unit: itemUnit
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Success!', `Item "${itemName}" added successfully to inventory`, 'success');
                    document.getElementById('addItemForm').reset();
                    loadItems();
                    loadItemsForInvoice();
                    
                    // Show QR code if available
                    if (data.qr_code) {
                        setTimeout(() => {
                            showQRCodeModal(data.qr_code, data.item);
                        }, 500);
                    }
                } else {
                    showPopup('Error ‚ùå', 'Error adding item: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error adding item:', error);
                showPopup('Error ‚ùå', 'Failed to add item. Please try again.', 'alert');
            }
        });

        document.getElementById('addCustomerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const customerName = document.getElementById('newCustomerName').value.trim();
            const customerPhone = document.getElementById('newCustomerPhone').value.trim();
            const customerEmail = document.getElementById('newCustomerEmail').value.trim();
            const customerAddress = document.getElementById('newCustomerAddress').value.trim();

            if (!customerName || !customerPhone || !customerEmail || !customerAddress) {
                showPopup('Invalid Input ‚ö†Ô∏è', 'All customer fields are required: name, phone, email, and address.', 'alert');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/customers`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        customer_name: customerName,
                        customer_phone: customerPhone,
                        customer_email: customerEmail,
                        customer_address: customerAddress
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Success!', `Customer "${customerName}" added successfully`, 'success');
                    document.getElementById('addCustomerForm').reset();
                    loadCustomers();
                } else {
                    showPopup('Error ‚ùå', 'Error adding customer: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error adding customer:', error);
                showPopup('Error ‚ùå', 'Failed to add customer. Please try again.', 'alert');
            }
        });

        async function updateItemStock(itemId, itemName) {
            showInputPopup(
                'Update Stock üì¶',
                `Enter additional stock for "${itemName}":`,
                'number',
                '10',
                (value) => processStockUpdate(itemId, itemName, value)
            );
        }
        
        async function processStockUpdate(itemId, itemName, additionalStock) {
            if (!additionalStock || additionalStock === '') return;

            const stock = parseInt(additionalStock);
            if (isNaN(stock) || stock < 0) {
                showPopup('Invalid Stock ‚ö†Ô∏è', 'Please enter a valid positive stock quantity.', 'alert');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/items/${itemId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        stock: stock,
                        update_type: 'add'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showPopup('Stock Updated! üì¶', data.message, 'alert');
                    loadItems();
                    loadItemsForInvoice();
                } else {
                    showPopup('Error ‚ùå', 'Error updating stock: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error updating stock:', error);
                showPopup('Error ‚ùå', 'Failed to update stock. Please try again.', 'alert');
            }
        }

        async function updateItemPrice(itemId, itemName) {
            showInputPopup(
                'Update Price üí∞',
                `Enter new price for "${itemName}" (‚Çπ):`,
                'number',
                '100.00',
                (value) => processPriceUpdate(itemId, itemName, value)
            );
        }
        
        async function processPriceUpdate(itemId, itemName, newPrice) {
            if (!newPrice || newPrice === '') return;

            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) {
                showPopup('Invalid Price ‚ö†Ô∏è', 'Please enter a valid price (must be greater than 0).', 'alert');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/items/${itemId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        item_price: price
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showPopup('Price Updated! üí∞', data.message, 'alert');
                    loadItems();
                    loadItemsForInvoice();
                } else {
                    showPopup('Error ‚ùå', 'Error updating price: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error updating price:', error);
                showPopup('Error ‚ùå', 'Failed to update price. Please try again.', 'alert');
            }
        }

        async function deleteItem(itemId, itemName) {
            showPopup(
                'Delete Item? üóëÔ∏è',
                `Are you sure you want to permanently delete "${itemName}" from inventory?\n\nThis action cannot be undone!`,
                'confirm',
                () => processDeleteItem(itemId, itemName)
            );
        }
        
        async function processDeleteItem(itemId, itemName) {

            try {
                const response = await fetch(`${API_BASE}/api/items/${itemId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders(),
                });

                const data = await response.json();

                if (data.success) {
                    showPopup('Deleted! üóëÔ∏è', data.message, 'alert');
                    loadItems();
                    loadItemsForInvoice();
                } else {
                    showPopup('Error ‚ùå', 'Error deleting item: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showPopup('Error ‚ùå', 'Failed to delete item. Please try again.', 'alert');
            }
        }

        // Customer Management Functions
        async function loadCustomers() {
            try {
                const response = await fetch(`${API_BASE}/api/customers`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (handleAuthError(data)) return;

                const customersTable = document.getElementById('customersTable');

                if (data.success && data.customers.length > 0) {
                    const customers = data.customers;
                    customersTable.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Address</th>
                                    <th>Total Purchases</th>
                                    <th>Total Spent</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            ${customers.map(customer => `
                                <tr>
                                    <td style="font-weight: bold;">${customer.customer_name}</td>
                                    <td>üì± ${customer.customer_phone}</td>
                                    <td>${customer.customer_email || '-'}</td>
                                    <td>${customer.customer_address || '-'}</td>
                                    <td style="text-align: center;">${customer.total_purchases || 0}</td>
                                    <td style="color: #138808; font-weight: bold;">${formatCurrency(customer.total_spent || 0)}</td>
                                    <td class="actions-column">
                                        <div class="action-buttons">
                                            <button onclick="editCustomer('${customer._id}')" class="btn-icon" title="Edit Customer">‚úèÔ∏è</button>
                                            <button onclick="deleteCustomer('${customer._id}', '${customer.customer_name}')" class="btn-icon" title="Delete Customer">üóëÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    customersTable.innerHTML = `
                        <div class="empty-state">
                            <h3>üë• No Customers Yet</h3>
                            <p>Add your first customer using the form above</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                document.getElementById('customersTable').innerHTML = '<p class="error">Error loading customers. Please try again.</p>';
            }
        }

        async function searchCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.trim();
            if (!searchTerm) {
                loadCustomers();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/customers/search?q=${encodeURIComponent(searchTerm)}`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (handleAuthError(data)) return;

                const customersTable = document.getElementById('customersTable');

                if (data.success && data.customers.length > 0) {
                    const customers = data.customers;
                    customersTable.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Address</th>
                                    <th>Total Purchases</th>
                                    <th>Total Spent</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            ${customers.map(customer => `
                                <tr>
                                    <td style="font-weight: bold;">${customer.customer_name}</td>
                                    <td>üì± ${customer.customer_phone}</td>
                                    <td>${customer.customer_email || '-'}</td>
                                    <td>${customer.customer_address || '-'}</td>
                                    <td style="text-align: center;">${customer.total_purchases || 0}</td>
                                    <td style="color: #138808; font-weight: bold;">${formatCurrency(customer.total_spent || 0)}</td>
                                    <td class="actions-column">
                                        <div class="action-buttons">
                                            <button onclick="editCustomer('${customer._id}')" class="btn-icon" title="Edit Customer">‚úèÔ∏è</button>
                                            <button onclick="deleteCustomer('${customer._id}', '${customer.customer_name}')" class="btn-icon" title="Delete Customer">üóëÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    customersTable.innerHTML = `
                        <div class="empty-state">
                            <h3>üîç No Customers Found</h3>
                            <p>No customers match your search: "${searchTerm}"</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error searching customers:', error);
                showPopup('Error ‚ùå', 'Failed to search customers. Please try again.', 'alert');
            }
        }

        async function editCustomer(customerId) {
            try {
                // Fetch customer data first
                const response = await fetch(`${API_BASE}/api/customers`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (handleAuthError(data)) return;
                
                const customer = data.customers.find(c => c._id === customerId);
                if (!customer) {
                    showPopup('Error ‚ùå', 'Customer not found', 'alert');
                    return;
                }
                
                // Prompt for new values
                const newName = prompt('Enter new customer name:', customer.customer_name);
                if (newName === null) return;
                
                const newPhone = prompt('Enter new phone number:', customer.customer_phone);
                if (newPhone === null) return;
                
                const newEmail = prompt('Enter new email (optional):', customer.customer_email || '');
                if (newEmail === null) return;
                
                const newAddress = prompt('Enter new address (optional):', customer.customer_address || '');
                if (newAddress === null) return;
                
                // Update customer
                const updateResponse = await fetch(`${API_BASE}/api/customers/${customerId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        customer_name: newName.trim(),
                        customer_phone: newPhone.trim(),
                        customer_email: newEmail.trim(),
                        customer_address: newAddress.trim()
                    })
                });
                
                const updateData = await updateResponse.json();
                
                if (updateData.success) {
                    showNotification('Success!', 'Customer updated successfully', 'success');
                    loadCustomers();
                } else {
                    showPopup('Error ‚ùå', updateData.error, 'alert');
                }
            } catch (error) {
                console.error('Error editing customer:', error);
                showPopup('Error ‚ùå', 'Failed to edit customer. Please try again.', 'alert');
            }
        }

        async function deleteCustomer(customerId, customerName) {
            showPopup(
                'Delete Customer? üóëÔ∏è',
                `Are you sure you want to delete "${customerName}"?\n\nThis action cannot be undone!`,
                'confirm',
                () => processDeleteCustomer(customerId, customerName)
            );
        }

        async function processDeleteCustomer(customerId, customerName) {
            try {
                const response = await fetch(`${API_BASE}/api/customers/${customerId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Deleted!', `${customerName} has been removed`, 'success');
                    loadCustomers();
                } else {
                    showPopup('Error ‚ùå', data.error, 'alert');
                }
            } catch (error) {
                console.error('Error deleting customer:', error);
                showPopup('Error ‚ùå', 'Failed to delete customer. Please try again.', 'alert');
            }
        }

        // Invoice functions
        async function loadCustomersForInvoice() {
            try {
                const response = await fetch(`${API_BASE}/api/customers`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (handleAuthError(data)) return;

                if (data.success) {
                    const select = document.getElementById('customerSelect');
                    select.innerHTML = '<option value="">-- Select a customer or enter new details below --</option>' +
                        data.customers
                            .map(customer => `<option value="${customer._id}" 
                                data-name="${customer.customer_name}" 
                                data-phone="${customer.customer_phone}" 
                                data-email="${customer.customer_email}" 
                                data-address="${customer.customer_address}">
                                ${customer.customer_name} - ${customer.customer_phone}
                            </option>`)
                            .join('');
                }
            } catch (error) {
                console.error('Error loading customers for invoice:', error);
            }
        }

        document.getElementById('customerSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            
            if (this.value) {
                // Populate form fields with selected customer data
                document.getElementById('customerName').value = selectedOption.getAttribute('data-name') || '';
                document.getElementById('customerPhone').value = selectedOption.getAttribute('data-phone') || '';
                document.getElementById('customerEmail').value = selectedOption.getAttribute('data-email') || '';
                document.getElementById('customerAddress').value = selectedOption.getAttribute('data-address') || '';
                
                // Make fields readonly when customer is selected
                document.getElementById('customerName').readOnly = true;
                document.getElementById('customerPhone').readOnly = true;
                document.getElementById('customerEmail').readOnly = true;
                document.getElementById('customerAddress').readOnly = true;
            } else {
                // Clear fields and make them editable
                document.getElementById('customerName').value = '';
                document.getElementById('customerPhone').value = '';
                document.getElementById('customerEmail').value = '';
                document.getElementById('customerAddress').value = '';
                
                document.getElementById('customerName').readOnly = false;
                document.getElementById('customerPhone').readOnly = false;
                document.getElementById('customerEmail').readOnly = false;
                document.getElementById('customerAddress').readOnly = false;
            }
        });

        async function loadItemsForInvoice() {
            try {
                const response = await fetch(`${API_BASE}/api/items`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (handleAuthError(data)) return;

                if (data.success) {
                    const select = document.getElementById('invoiceItemSelect');
                    select.innerHTML = '<option value="">Select an item...</option>' +
                        data.items
                            .filter(item => item.stock > 0)
                            .map(item => `<option value="${item._id}" data-price="${item.item_price}" data-stock="${item.stock}" data-unit="${item.unit || 'pcs'}">${item.item_name} - ${formatCurrency(item.item_price)} (Stock: ${item.stock} ${item.unit || 'pcs'})</option>`)
                            .join('');
                } else {
                    showPopup('Error ‚ùå', 'Error loading items for invoice: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error loading items for invoice:', error);
                showPopup('Error ‚ùå', 'Failed to load items for invoice. Please refresh the page.', 'alert');
            }
        }

        document.getElementById('invoiceItemSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const stock = selectedOption.getAttribute('data-stock');
            document.getElementById('availableStock').value = stock || '';
        });

        function addItemToInvoice() {
            const select = document.getElementById('invoiceItemSelect');
            const quantity = parseInt(document.getElementById('invoiceQuantity').value);
            const availableStock = parseInt(document.getElementById('availableStock').value);

            if (!select.value) {
                showPopup('No Item Selected ‚ö†Ô∏è', 'Please select an item from the dropdown.', 'alert');
                return;
            }

            if (!quantity || quantity < 1) {
                showPopup('Invalid Quantity ‚ö†Ô∏è', 'Please enter a valid quantity (minimum 1).', 'alert');
                return;
            }

            if (quantity > availableStock) {
                showPopup('Insufficient Stock ‚ö†Ô∏è', `Not enough stock available. Only ${availableStock} units in stock.`, 'alert');
                return;
            }

            const selectedOption = select.options[select.selectedIndex];
            const itemId = select.value;
            const itemName = selectedOption.text.split(' - ')[0];
            const itemPrice = parseFloat(selectedOption.getAttribute('data-price'));
            const itemUnit = selectedOption.getAttribute('data-unit') || 'pcs';

            // Check if item already exists in invoice
            const existingItemIndex = invoiceItems.findIndex(item => item.item_id === itemId);
            if (existingItemIndex >= 0) {
                const totalQuantity = invoiceItems[existingItemIndex].quantity + quantity;
                if (totalQuantity > availableStock) {
                    showPopup('Stock Limit Exceeded ‚ö†Ô∏è', `Total quantity would exceed available stock. Only ${availableStock} units available.`, 'alert');
                    return;
                }
                invoiceItems[existingItemIndex].quantity = totalQuantity;
                invoiceItems[existingItemIndex].unit = itemUnit;
            } else {
                invoiceItems.push({
                    item_id: itemId,
                    name: itemName,
                    price: itemPrice,
                    quantity: quantity,
                    unit: itemUnit
                });
            }

            displayInvoiceItems();
            calculateInvoiceTotals();
            
            showPopup('Added! ‚úÖ', `${itemName} (${quantity} qty) added to invoice successfully.`, 'alert');

            // Reset form
            select.value = '';
            document.getElementById('invoiceQuantity').value = '1';
            document.getElementById('availableStock').value = '';
        }

        function displayInvoiceItems() {
            const container = document.getElementById('invoiceItemsList');
            
            if (invoiceItems.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No items added to invoice</p></div>';
                return;
            }

            container.innerHTML = invoiceItems.map((item, index) => `
                <div class="invoice-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 2px solid #e9ecef; margin-bottom: 10px; border-radius: 10px; background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="flex: 1;">
                        <strong style="color: #FF9933; font-size: 1.1em;">${item.name}</strong><br>
                        <span style="color: #666; font-size: 0.9em;">${item.quantity} ${item.unit || 'pcs'} √ó ${formatCurrency(item.price)} = <strong style="color: #138808;">${formatCurrency(item.quantity * item.price)}</strong></span>
                    </div>
                    <button onclick="confirmRemoveItemFromInvoice(${index})" 
                            class="btn btn-danger" 
                            style="background: linear-gradient(45deg, #FF6B6B, #FF8E53); border: none; 
                                   padding: 8px 15px; border-radius: 8px; color: white; font-weight: bold;
                                   transition: all 0.3s ease; box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(255, 107, 107, 0.4)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(255, 107, 107, 0.3)'">
                        üóëÔ∏è Remove
                    </button>
                </div>
            `).join('');
        }

        function confirmRemoveItemFromInvoice(index) {
            const item = invoiceItems[index];
            showPopup(
                'Remove Item? üóëÔ∏è', 
                `Are you sure you want to remove "${item.name}" from the invoice?`,
                'confirm',
                () => removeItemFromInvoice(index)
            );
        }
        
        function removeItemFromInvoice(index) {
            const item = invoiceItems[index];
            invoiceItems.splice(index, 1);
            displayInvoiceItems();
            calculateInvoiceTotals();
            showPopup('Removed! ‚úÖ', `"${item.name}" removed from invoice successfully.`, 'alert');
        }

        function roundToCustomFormat(amount) {
            // Round to nearest integer first
            const rounded = Math.round(amount);
            const lastDigit = rounded % 10;
            
            if (lastDigit >= 0 && lastDigit <= 4) {
                // Round down to nearest 10 (except 5)
                return Math.floor(rounded / 10) * 10;
            } else if (lastDigit === 5) {
                // Keep as is (ends with 5)
                return rounded;
            } else { // lastDigit >= 6 && lastDigit <= 9
                // Round up to nearest 10
                return Math.ceil(rounded / 10) * 10;
            }
        }

        function calculateInvoiceTotals() {
            if (invoiceItems.length === 0) {
                document.getElementById('invoiceSummary').style.display = 'none';
                document.getElementById('generateBtn').disabled = true;
                return;
            }

            const subtotal = invoiceItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
            const tax = subtotal * (taxRate / 100);
            const discount = subtotal * (discountRate / 100);
            const calculatedTotal = subtotal + tax - discount;
            const total = roundToCustomFormat(calculatedTotal);

            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('tax').textContent = formatCurrency(tax);
            document.getElementById('discount').textContent = formatCurrency(discount);
            document.getElementById('total').textContent = formatCurrency(total);

            document.getElementById('invoiceSummary').style.display = 'block';
            document.getElementById('generateBtn').disabled = false;
        }

        async function generateInvoice() {
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const customerAddress = document.getElementById('customerAddress').value.trim();
            const customerEmail = document.getElementById('customerEmail').value.trim();
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
            const sendEmail = document.getElementById('sendEmailCheckbox').checked;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const notes = document.getElementById('invoiceNotes').value.trim();

            if (!customerName || !customerPhone || !customerAddress) {
                showPopup('Missing Information ‚ö†Ô∏è', 'Please fill in all customer information before generating invoice.', 'alert');
                return;
            }

            if (sendEmail && !customerEmail) {
                showPopup('Email Required ‚ö†Ô∏è', 'Please enter customer email address to send the invoice via email.', 'alert');
                return;
            }

            if (invoiceItems.length === 0) {
                showPopup('No Items ‚ö†Ô∏è', 'Please add items to the invoice before generating.', 'alert');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/invoices`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('session_token')}`
                    },
                    body: JSON.stringify({
                        customer_name: customerName,
                        customer_address: customerAddress,
                        customer_number: customerPhone,
                        customer_email: customerEmail,
                        items: invoiceItems,
                        tax_rate: taxRate,
                        discount_rate: discountRate,
                        payment_method: paymentMethod,
                        notes: notes,
                        send_email: sendEmail
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const message = data.email_sent 
                        ? `Invoice #${data.invoice.invoice_id} created and sent to ${customerEmail}! Would you like to download the PDF?`
                        : `Invoice #${data.invoice.invoice_id} created successfully! Would you like to download the PDF?`;
                    
                    showPopup(
                        'Invoice Created! üìÑ', 
                        message,
                        'confirm',
                        () => {
                            const sessionToken = localStorage.getItem('session_token');
                            window.open(`${API_BASE}/api/invoices/${data.invoice.invoice_id}/pdf?session_token=${sessionToken}`, '_blank');
                        }
                    );
                    clearInvoiceForm();
                } else {
                    showPopup('Error ‚ùå', 'Error creating invoice: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error creating invoice:', error);
                showPopup('Error ‚ùå', 'Failed to create invoice. Please try again.', 'alert');
            }
        }

        function clearInvoiceForm() {
            document.getElementById('customerSelect').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerName').readOnly = false;
            document.getElementById('customerPhone').readOnly = false;
            document.getElementById('customerEmail').readOnly = false;
            document.getElementById('customerAddress').readOnly = false;
            document.getElementById('sendEmailCheckbox').checked = false;
            document.getElementById('paymentMethod').value = 'cash';
            document.getElementById('invoiceNotes').value = '';
            document.getElementById('taxRate').value = '0';
            document.getElementById('discountRate').value = '0';
            invoiceItems = [];
            displayInvoiceItems();
            calculateInvoiceTotals();
        }

        // Recalculate totals when tax/discount inputs change
        document.getElementById('taxRate').addEventListener('input', calculateInvoiceTotals);
        document.getElementById('discountRate').addEventListener('input', calculateInvoiceTotals);

        // Invoices functions
        async function loadInvoices() {
            try {
                const response = await fetch(`${API_BASE}/api/invoices`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (handleAuthError(data)) return;

                if (data.success) {
                    displayInvoices(data.invoices);
                } else {
                    showPopup('Error ‚ùå', 'Error loading invoices: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error loading invoices:', error);
                showPopup('Error ‚ùå', 'Failed to load invoices. Please refresh the page.', 'alert');
            }
        }

        function displayInvoices(invoices) {
            const invoicesTable = document.getElementById('invoicesTable');
            
            if (invoices.length === 0) {
                invoicesTable.innerHTML = '<div class="empty-state"><h3>No invoices found</h3><p>Create your first invoice to get started</p></div>';
                return;
            }

            invoicesTable.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoices.map(invoice => `
                                <tr>
                                    <td><strong style="color: #138808;">#${invoice.invoice_id}</strong></td>
                                    <td><strong>${invoice.customer_name}</strong></td>
                                    <td>${formatDate(invoice.order_date)}</td>
                                    <td><strong style="color: #138808; font-size: 1.1em;">‚Çπ${invoice.total.toFixed(2)}</strong></td>
                                    <td>
                                        <div class="action-buttons">
                                            <button onclick="viewInvoiceDetails(${invoice.invoice_id})" class="btn btn-primary" title="View Details">üëÅÔ∏è View</button>
                                            <button onclick="downloadInvoicePDF(${invoice.invoice_id})" class="btn btn-success" title="Download PDF">üìÑ PDF</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function viewInvoiceDetails(invoiceId) {
            try {
                const response = await fetch(`${API_BASE}/api/invoices/${invoiceId}`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (handleAuthError(data)) return;

                if (data.success) {
                    const invoice = data.invoice;
                    const details = `
                        Invoice ID: #${invoice.invoice_id}
                        Customer: ${invoice.customer_name}
                        Address: ${invoice.customer_address}
                        Phone: ${invoice.customer_number}
                        Date: ${formatDate(invoice.order_date)}
                        
                        Items:
                        ${invoice.items.map(item => `${item.name} - ${item.quantity} x ${formatCurrency(item.price)} = ${formatCurrency(item.quantity * item.price)}`).join('\n')}
                        
                        Subtotal: ${formatCurrency(invoice.subtotal)}
                        Tax (${(invoice.tax_rate ?? 0).toFixed(2)}%): ${formatCurrency(invoice.tax)}
                        Discount (${(invoice.discount_rate ?? 0).toFixed(2)}%): ${formatCurrency(invoice.discount)}
                        Total: ${formatCurrency(invoice.total)}
                    `;
                    alert(details);
                } else {
                    showPopup('Error ‚ùå', 'Error loading invoice details: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error loading invoice details:', error);
                showPopup('Error ‚ùå', 'Failed to load invoice details. Please try again.', 'alert');
            }
        }

        function downloadInvoicePDF(invoiceId) {
            const sessionToken = localStorage.getItem('session_token');
            window.open(`${API_BASE}/api/invoices/${invoiceId}/pdf?session_token=${sessionToken}`, '_blank');
        }

        function searchInvoices() {
            const searchTerm = document.getElementById('invoiceSearch').value.trim().toLowerCase();
            
            if (!searchTerm) {
                loadInvoices();
                return;
            }

            // Simple client-side search (you could implement server-side search)
            const filteredInvoices = currentInvoices.filter(invoice => 
                invoice.customer_name.toLowerCase().includes(searchTerm) ||
                invoice.invoice_id.toString().includes(searchTerm)
            );
            
            displayInvoices(filteredInvoices);
        }

        // Initialize the application
        let currentInvoices = [];
        let qrScannerStream = null;

        // QR Code Functions
        async function showItemQR(itemId) {
            try {
                const response = await fetch(`${API_BASE}/api/items/${itemId}/qrcode`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    showQRCodeModal(data.qr_code, data.item);
                } else {
                    showPopup('Error ‚ùå', 'Failed to generate QR code: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error fetching QR code:', error);
                showPopup('Error ‚ùå', 'Failed to generate QR code', 'alert');
            }
        }
        
        function showQRCodeModal(qrCode, item) {
            const modal = document.getElementById('qrModal');
            const img = document.getElementById('qrCodeImage');
            const info = document.getElementById('qrItemInfo');
            
            img.src = `data:image/png;base64,${qrCode}`;
            info.textContent = `${item.item_name} - Rs ${item.item_price} per ${item.unit}`;
            
            modal.style.display = 'flex';
            modal.classList.add('show');
        }
        
        function closeQRModal() {
            const modal = document.getElementById('qrModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 200);
        }
        
        function printQR() {
            const img = document.getElementById('qrCodeImage');
            const info = document.getElementById('qrItemInfo');
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Print QR Code</title>
                        <style>
                            body { text-align: center; font-family: Arial; padding: 20px; }
                            img { max-width: 400px; border: 2px solid #138808; padding: 20px; }
                            h2 { color: #138808; }
                        </style>
                    </head>
                    <body>
                        <h2>Item QR Code</h2>
                        <img src="${img.src}">
                        <h3>${info.textContent}</h3>
                        <p>Scan this QR code to quickly add item to invoice</p>
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(() => window.close(), 100);
                            }
                        <\/script>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // QR Scanner Functions
        function openQRScanner() {
            const modal = document.getElementById('qrScannerModal');
            const video = document.getElementById('qrVideo');
            
            modal.style.display = 'flex';
            modal.classList.add('show');
            
            // Start camera
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(stream) {
                    qrScannerStream = stream;
                    video.srcObject = stream;
                    video.setAttribute('playsinline', true);
                    video.play();
                    requestAnimationFrame(scanQRCode);
                })
                .catch(function(err) {
                    console.error('Error accessing camera:', err);
                    showPopup('Camera Error ‚ùå', 'Could not access camera. Please check permissions.', 'alert');
                    closeQRScanner();
                });
        }
        
        function scanQRCode() {
            const video = document.getElementById('qrVideo');
            const canvas = document.getElementById('qrCanvas');
            const modal = document.getElementById('qrScannerModal');
            
            if (modal.style.display === 'none' || !video.videoWidth) {
                if (modal.style.display !== 'none') {
                    requestAnimationFrame(scanQRCode);
                }
                return;
            }
            
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) {
                try {
                    const itemData = JSON.parse(code.data);
                    console.log('QR Code scanned:', itemData);
                    
                    closeQRScanner();
                    addScannedItemToInvoice(itemData);
                } catch (e) {
                    console.error('Invalid QR code data:', e);
                }
            }
            
            requestAnimationFrame(scanQRCode);
        }
        
        function closeQRScanner() {
            const modal = document.getElementById('qrScannerModal');
            const video = document.getElementById('qrVideo');
            
            if (qrScannerStream) {
                qrScannerStream.getTracks().forEach(track => track.stop());
                qrScannerStream = null;
            }
            
            video.srcObject = null;
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 200);
        }
        
        function addScannedItemToInvoice(itemData) {
            showInputPopup(
                'üéØ Item Scanned Successfully!',
                `<strong>${itemData.item_name}</strong><br>Price: Rs ${itemData.item_price} per ${itemData.unit}<br><br>Enter quantity:`,
                'number',
                '1',
                (quantity) => {
                    if (!quantity || quantity <= 0) {
                        showPopup('Invalid Quantity ‚ö†Ô∏è', 'Please enter a valid quantity', 'alert');
                        return;
                    }
                    
                    // Set the item in the dropdown
                    const select = document.getElementById('invoiceItemSelect');
                    select.value = itemData.item_id;
                    
                    // Set quantity
                    document.getElementById('invoiceQuantity').value = quantity;
                    
                    // Trigger the add item action
                    addItemToInvoice();
                }
            );
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            
            // Add search functionality with Enter key
            document.getElementById('itemSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchItems();
                }
            });
            
            document.getElementById('customerSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchCustomers();
                }
            });
            
            document.getElementById('invoiceSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchInvoices();
                }
            });
        });
    </script>
    
    <!-- Footer -->
    <div style="text-align: center; padding: 30px 20px; margin-top: 40px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <p style="color: #138808; font-weight: bold; font-size: 1.2em; margin: 0 0 10px 0;">
            ‚ö° Kandhal Invoice System
        </p>
        <p style="color: #666; font-size: 0.9em; margin: 0;">
            Powered by Kandhal Technologies | Modern Invoice Management Solution
        </p>
    </div>
</body>
</html>