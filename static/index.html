<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shakil's Grocery Shop - MongoDB Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
            background: linear-gradient(135deg, #ff9933 0%, #138808 25%, #ffffff 50%, #138808 75%, #ff9933 100%);
            background-size: 400% 400%;
            animation: indianFlag 10s ease-in-out infinite;
            min-height: 100vh;
            color: #2c3e50;
        }

        @keyframes indianFlag {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
        }

        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 3px solid #ff9933;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff9933, #ffffff, #138808);
            animation: slideBar 3s linear infinite;
        }

        @keyframes slideBar {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .header h1 {
            color: #138808;
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            color: #ff9933;
            font-size: 1.4em;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            border: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 18px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.4s ease;
            margin: 0 3px;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,153,51,0.2), transparent);
            transition: left 0.5s;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab:hover {
            background: rgba(255, 153, 51, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 153, 51, 0.3);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #138808 0%, #28a745 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(19, 136, 8, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 35px;
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            border: 1px solid #e9ecef;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff9933 0%, #ffffff 50%, #138808 100%);
        }

        .card h2 {
            color: #138808;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: bold;
            border-bottom: 2px solid #ff9933;
            padding-bottom: 10px;
            display: inline-block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1.1em;
            transition: all 0.3s ease;
            background: #ffffff;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #138808;
            box-shadow: 0 0 0 3px rgba(19, 136, 8, 0.1), inset 0 2px 4px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.4s ease;
            margin-right: 12px;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 120px;
        }
        
        @media (max-width: 480px) {
            .btn {
                padding: 12px 20px;
                font-size: 1em;
                margin-right: 8px;
                margin-bottom: 8px;
                min-width: 100px;
            }
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transition: width 0.6s, height 0.6s;
            transform: translate(-50%, -50%);
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #138808 0%, #28a745 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(19, 136, 8, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(19, 136, 8, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9933 0%, #e67e22 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 153, 51, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 153, 51, 0.4);
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 5px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: #34495e;
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            border: 1px solid #e9ecef;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(19,136,8,0.1), transparent);
            transition: left 0.8s ease;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 35px rgba(19, 136, 8, 0.2);
        }

        .stat-card h3 {
            color: #138808;
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .stat-card p {
            color: #ff9933;
            font-size: 1.3em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .invoice-items {
            margin: 20px 0;
        }
        
        .invoice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }        .invoice-summary {
            background: #34495e;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .invoice-summary .row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .invoice-summary .total {
            font-size: 1.3em;
            font-weight: bold;
            border-top: 1px solid #fff;
            padding-top: 10px;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 5px;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }

            .invoice-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        /* Enhanced Popup Modal Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 153, 51, 0.1) 0%, rgba(19, 136, 8, 0.1) 50%, rgba(255, 255, 255, 0.1) 100%);
            backdrop-filter: blur(8px) saturate(150%);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }
        
        .popup-modal {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 50%, #ffffff 100%);
            padding: 35px 40px;
            border-radius: 20px;
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            max-width: 450px;
            width: 95%;
            text-align: center;
            transform: scale(0.8) translateY(30px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            overflow: hidden;
        }
        
        .popup-modal::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #FF9933, #FFFFFF, #138808, #FF9933);
            background-size: 300% 300%;
            border-radius: 22px;
            z-index: -1;
            animation: gradientBorder 3s ease infinite;
        }
        
        @keyframes gradientBorder {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .popup-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        
        .popup-overlay.show .popup-modal {
            transform: scale(1) translateY(0);
        }
        
        .popup-overlay.hide {
            animation: fadeOut 0.2s ease-in;
        }
        
        .popup-overlay.hide .popup-modal {
            transform: scale(0.9) translateY(20px);
            opacity: 0;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .popup-modal h3 {
            color: #FF9933;
            margin-bottom: 20px;
            font-size: 1.6em;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(255, 153, 51, 0.3);
            position: relative;
            padding-bottom: 15px;
        }
        
        .popup-modal h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #FF9933, #138808);
            border-radius: 2px;
        }
        
        .popup-modal p {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 1.15em;
            line-height: 1.6;
            font-weight: 500;
            text-align: center;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .popup-modal input,
        .popup-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1.1em;
            margin-bottom: 25px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .popup-modal input:focus,
        .popup-input:focus {
            outline: none;
            border-color: #FF9933;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(255, 153, 51, 0.1), inset 0 2px 4px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }
        
        .popup-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .popup-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.05em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 120px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .popup-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .popup-btn:hover::before {
            left: 100%;
        }
        
        .popup-btn.confirm {
            background: linear-gradient(135deg, #FF9933 0%, #FF6B35 50%, #E8751A 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(255, 153, 51, 0.3);
        }
        
        .popup-btn.confirm:hover {
            background: linear-gradient(135deg, #FF8C1A 0%, #FF5722 50%, #D84315 100%);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 153, 51, 0.4);
        }
        
        .popup-btn.confirm:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 4px 15px rgba(255, 153, 51, 0.3);
        }
        
        .popup-btn.cancel {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 50%, #495057 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.2);
        }
        
        .popup-btn.cancel:hover {
            background: linear-gradient(135deg, #5a6268 0%, #495057 50%, #343a40 100%);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }
        
        .popup-btn.cancel:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.2);
        }
        
        .popup-btn.ok {
            background: linear-gradient(135deg, #138808 0%, #28a745 50%, #20c997 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(19, 136, 8, 0.3);
        }
        
        .popup-btn.ok:hover {
            background: linear-gradient(135deg, #0f6808 0%, #218838 50%, #1e7e34 100%);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(19, 136, 8, 0.4);
        }
        
        .popup-btn.ok:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 4px 15px rgba(19, 136, 8, 0.3);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-tab {
                min-width: auto;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .popup-modal {
                margin: 20px;
                padding: 25px 30px;
                max-width: none;
                width: auto;
            }
            
            .popup-modal h3 {
                font-size: 1.4em;
            }
            
            .popup-modal p {
                font-size: 1.1em;
            }
            
            .popup-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .popup-btn {
                width: 100%;
                padding: 12px 20px;
                font-size: 1em;
            }
            
            .invoice-item {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            table {
                font-size: 0.9em;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 20px;
            }
            
            .popup-modal {
                margin: 15px;
                padding: 20px 25px;
            }
            
            .popup-modal h3 {
                font-size: 1.3em;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" id="mainHeader">
            <h1 id="shopNameHeader">üè™ Loading...</h1>
            <p>MongoDB-Powered Invoice Management System</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard', this)">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('items', this)">üì¶ Items</button>
            <button class="nav-tab" onclick="showTab('invoice', this)">üßæ Create Invoice</button>
            <button class="nav-tab" onclick="showTab('invoices', this)">üìã View Invoices</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalInvoices">-</h3>
                    <p>Total Invoices</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalRevenue">-</h3>
                    <p>Total Revenue</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalItems">-</h3>
                    <p>Items in Stock</p>
                </div>
            </div>

            <div class="card">
                <h2>üìà Top Customers</h2>
                <div id="topCustomers" class="loading">Loading...</div>
            </div>

            <div class="card">
                <h2>üìÖ Recent Sales</h2>
                <div id="recentSales" class="loading">Loading...</div>
            </div>
        </div>

        <!-- Items Tab -->
        <div id="items" class="tab-content">
            <div class="card">
                <h2>‚ûï Add New Item</h2>
                <form id="addItemForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 25px;">
                        <div class="form-group">
                            <label>üì¶ Item Name</label>
                            <input type="text" id="itemName" placeholder="Enter item name" required>
                        </div>
                        <div class="form-group">
                            <label>üí∞ Price (‚Çπ)</label>
                            <input type="number" step="0.01" id="itemPrice" placeholder="Enter price in rupees" required>
                        </div>
                        <div class="form-group">
                            <label>üìä Stock Quantity</label>
                            <input type="number" id="itemStock" placeholder="Enter stock quantity" required>
                        </div>
                        <div class="form-group">
                            <label>üìè Unit</label>
                            <select id="itemUnit" required style="padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1.1em; background: #f8f9fa;">
                                <option value="">Select Unit</option>
                                <option value="kg">Kilogram (kg)</option>
                                <option value="gm">Gram (gm)</option>
                                <option value="l">Liter (l)</option>
                                <option value="ml">Milliliter (ml)</option>
                                <option value="pcs">Pieces (pcs)</option>
                                <option value="pack">Pack</option>
                                <option value="box">Box</option>
                                <option value="bottle">Bottle</option>
                                <option value="bag">Bag</option>
                                <option value="dozen">Dozen</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Add Item</button>
                </form>
            </div>

            <div class="card">
                <h2>üì¶ Inventory Management</h2>
                <div class="search-bar">
                    <input type="text" id="itemSearch" placeholder="Search items...">
                    <button onclick="searchItems()" class="btn btn-primary">Search</button>
                    <button onclick="loadItems()" class="btn btn-warning">Show All</button>
                </div>
                <div id="itemsTable" class="loading">Loading items...</div>
            </div>
        </div>

        <!-- Create Invoice Tab -->
        <div id="invoice" class="tab-content">
            <div class="card">
                <h2>üë§ Customer Information</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                    <div class="form-group">
                        <label>üë§ Customer Name</label>
                        <input type="text" id="customerName" placeholder="Enter customer full name" required>
                    </div>
                    <div class="form-group">
                        <label>üì± Customer Phone</label>
                        <input type="tel" id="customerPhone" placeholder="+91 XXXXX XXXXX" pattern="[+][0-9]{2}[0-9]{5}[0-9]{5}" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>üè† Customer Address</label>
                    <textarea id="customerAddress" rows="3" placeholder="Enter complete address with city and state" required></textarea>
                </div>
            </div>

            <div class="card">
                <h2>üõí Add Items to Invoice</h2>
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 20px; align-items: end; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 15px; border: 2px dashed #138808;">
                    <div class="form-group">
                        <label>üõçÔ∏è Select Item</label>
                        <select id="invoiceItemSelect" style="background: #ffffff; border: 2px solid #138808;">
                            <option value="">Choose an item...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üî¢ Quantity</label>
                        <input type="number" id="invoiceQuantity" min="1" value="1" style="text-align: center; font-weight: bold; border: 2px solid #138808;">
                    </div>
                    <div class="form-group">
                        <label>üì¶ Available Stock</label>
                        <input type="number" id="availableStock" readonly style="background: #f8f9fa; text-align: center; font-weight: bold; border: 2px solid #6c757d;">
                    </div>
                    <div class="form-group">
                        <button onclick="addItemToInvoice()" class="btn btn-success" style="padding: 16px 24px; font-size: 1.2em;">‚ûï Add Item</button>
                    </div>
                </div>

                <div class="invoice-items">
                    <h3>Invoice Items</h3>
                    <div id="invoiceItemsList"></div>
                </div>

                <div id="invoiceSummary" class="invoice-summary" style="display: none;">
                    <div class="row">
                        <span>Subtotal:</span>
                        <span id="subtotal">Rs. 0.00</span>
                    </div>
                    <div class="row">
                        <label for="taxRate" style="display:flex; gap:8px; align-items:center; width:100%;">
                            <span>Tax (%)</span>
                            <input type="number" id="taxRate" value="0" min="0" step="0.01" style="width:120px; text-align:right; border:2px solid #138808; border-radius:8px; padding:6px 10px; font-weight:bold;">
                        </label>
                        <span id="tax">Rs. 0.00</span>
                    </div>
                    <div class="row">
                        <label for="discountRate" style="display:flex; gap:8px; align-items:center; width:100%;">
                            <span>Discount (%)</span>
                            <input type="number" id="discountRate" value="0" min="0" step="0.01" style="width:120px; text-align:right; border:2px solid #dc3545; border-radius:8px; padding:6px 10px; font-weight:bold;">
                        </label>
                        <span id="discount">Rs. 0.00</span>
                    </div>
                    <div class="row total">
                        <span>Total:</span>
                        <span id="total">Rs. 0.00</span>
                    </div>
                </div>

                <button onclick="generateInvoice()" class="btn btn-primary" style="margin-top: 20px;" disabled id="generateBtn">Generate Invoice</button>
            </div>
        </div>

        <!-- View Invoices Tab -->
        <div id="invoices" class="tab-content">
            <div class="card">
                <h2>üìã All Invoices</h2>
                <div class="search-bar">
                    <input type="text" id="invoiceSearch" placeholder="Search by customer name or invoice ID...">
                    <button onclick="searchInvoices()" class="btn btn-primary">Search</button>
                    <button onclick="loadInvoices()" class="btn btn-warning">Show All</button>
                </div>
                <div id="invoicesTable" class="loading">Loading invoices...</div>
            </div>
        </div>

        <!-- Alert container -->
        <div id="alertContainer"></div>
    </div>

    <!-- Custom Popup Modal -->
    <div id="popupOverlay" class="popup-overlay">
        <div class="popup-modal">
            <h3 id="popupTitle">Confirmation</h3>
            <p id="popupMessage">Are you sure?</p>
            <div class="popup-buttons" id="popupButtons">
                <button class="popup-btn cancel" onclick="hidePopup()">Cancel</button>
                <button class="popup-btn confirm" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5000';
        let currentItems = [];
        let invoiceItems = [];
        let popupCallback = null;
        
        // Check authentication on page load
        async function checkAuth() {
            const sessionToken = localStorage.getItem('session_token');
            
            if (!sessionToken) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/verify-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ session_token: sessionToken })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('user_email');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Update UI with user email
                const userEmail = localStorage.getItem('user_email');
                const shopName = localStorage.getItem('shop_name') || data.shop_name || 'Shop';
                const shopAddress = localStorage.getItem('shop_address') || data.shop_address || '';
                const shopPhone = localStorage.getItem('shop_phone') || data.shop_phone || '';
                
                // Update shop name in header
                document.getElementById('shopNameHeader').textContent = `üè™ ${shopName}`;
                document.title = `${shopName} - Invoice System`;
                
                // Store shop details if from API
                if (data.shop_name) {
                    localStorage.setItem('shop_name', data.shop_name);
                    localStorage.setItem('shop_address', data.shop_address);
                    localStorage.setItem('shop_phone', data.shop_phone);
                }
                
                if (userEmail) {
                    updateHeaderWithUser(userEmail);
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'login.html';
            }
        }
        
        function updateHeaderWithUser(email) {
            const header = document.querySelector('.header');
            const logoutBtn = document.createElement('div');
            logoutBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 15px;';
            logoutBtn.innerHTML = `
                <span style="color: #138808; font-weight: 600; font-size: 0.95em;">üë§ ${email}</span>
                <button onclick="logout()" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                    üö™ Logout
                </button>
            `;
            header.style.position = 'relative';
            header.appendChild(logoutBtn);
        }
        
        async function logout() {
            const sessionToken = localStorage.getItem('session_token');
            
            try {
                await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ session_token: sessionToken })
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('session_token');
            localStorage.removeItem('user_email');
            localStorage.removeItem('shop_name');
            localStorage.removeItem('shop_address');
            localStorage.removeItem('shop_phone');
            window.location.href = 'login.html';
        }
        
        // Run auth check immediately
        checkAuth();
        
        // Popup Functions
        function showPopup(title, message, type = 'confirm', callback = null) {
            document.getElementById('popupTitle').textContent = title;
            document.getElementById('popupMessage').textContent = message;
            popupCallback = callback;
            
            const buttonsDiv = document.getElementById('popupButtons');
            if (type === 'confirm') {
                buttonsDiv.innerHTML = `
                    <button class="popup-btn cancel" onclick="hidePopup()">Cancel</button>
                    <button class="popup-btn confirm" onclick="confirmAction()">Confirm</button>
                `;
            } else if (type === 'alert') {
                buttonsDiv.innerHTML = `
                    <button class="popup-btn ok" onclick="hidePopup()">OK</button>
                `;
            }
            
            const overlay = document.getElementById('popupOverlay');
            overlay.style.display = 'flex';
            overlay.classList.add('show');
            
            // Close on click outside modal
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    hidePopup();
                }
            };
            
            // Prevent modal click from closing
            overlay.querySelector('.popup-modal').onclick = function(e) {
                e.stopPropagation();
            };
            
            // Add keyboard support
            document.addEventListener('keydown', handlePopupKeydown);
        }
        
        function hidePopup() {
            const overlay = document.getElementById('popupOverlay');
            overlay.classList.add('hide');
            overlay.classList.remove('show');
            
            setTimeout(() => {
                overlay.style.display = 'none';
                overlay.classList.remove('hide');
                popupCallback = null;
            }, 200);
        }
        
        function confirmAction() {
            if (popupCallback) {
                popupCallback();
            }
            hidePopup();
        }
        
        // Input Popup for prompts
        function showInputPopup(title, message, inputType = 'text', placeholder = '', callback = null) {
            document.getElementById('popupTitle').textContent = title;
            document.getElementById('popupMessage').innerHTML = `
                <p style="margin-bottom: 20px;">${message}</p>
                <input type="${inputType}" id="popupInput" placeholder="${placeholder}" 
                       class="popup-input"
                       step="0.01" min="0">
            `;
            popupCallback = () => {
                const value = document.getElementById('popupInput').value;
                if (callback) callback(value);
            };
            
            const buttonsDiv = document.getElementById('popupButtons');
            buttonsDiv.innerHTML = `
                <button class="popup-btn cancel" onclick="hidePopup()">Cancel</button>
                <button class="popup-btn confirm" onclick="confirmAction()">Update</button>
            `;
            
            const overlay = document.getElementById('popupOverlay');
            overlay.style.display = 'flex';
            overlay.classList.add('show');
            
            // Close on click outside modal
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    hidePopup();
                }
            };
            
            // Prevent modal click from closing
            overlay.querySelector('.popup-modal').onclick = function(e) {
                e.stopPropagation();
            };
            
            // Add keyboard support
            document.addEventListener('keydown', handlePopupKeydown);
            
            // Focus on input and select text
            setTimeout(() => {
                const input = document.getElementById('popupInput');
                if (input) {
                    input.focus();
                    input.select();
                    
                    // Allow Enter key to confirm
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            confirmAction();
                        }
                    });
                }
            }, 100);
        }
        
        function handlePopupKeydown(e) {
            if (e.key === 'Escape' && document.getElementById('popupOverlay').classList.contains('show')) {
                hidePopup();
            }
        }

        // Utility functions
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR'
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        // Tab management
        function showTab(tabName, element = null) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            if (element) {
                element.classList.add('active');
            } else if (event && event.target) {
                event.target.classList.add('active');
            }

            // Load data based on tab
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'items') {
                loadItems();
                loadItemsForInvoice();
            } else if (tabName === 'invoice') {
                loadItemsForInvoice();
                clearInvoiceForm();
            } else if (tabName === 'invoices') {
                loadInvoices();
            }
        }

        // Dashboard functions
        async function loadDashboard() {
            try {
                const [statsResponse, itemsResponse] = await Promise.all([
                    fetch(`${API_BASE}/api/stats`),
                    fetch(`${API_BASE}/api/items`)
                ]);

                const statsData = await statsResponse.json();
                const itemsData = await itemsResponse.json();

                if (statsData.success) {
                    const stats = statsData.stats;
                    document.getElementById('totalInvoices').textContent = stats.total_invoices;
                    document.getElementById('totalRevenue').textContent = formatCurrency(stats.total_revenue);

                    // Top customers
                    const topCustomersDiv = document.getElementById('topCustomers');
                    if (stats.top_customers.length > 0) {
                        topCustomersDiv.innerHTML = stats.top_customers.map(customer => 
                            `<div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                                <span>${customer._id}</span>
                                <span>${formatCurrency(customer.total_spent)} (${customer.invoice_count} invoices)</span>
                            </div>`
                        ).join('');
                    } else {
                        topCustomersDiv.innerHTML = '<div class="empty-state"><h3>No customers yet</h3><p>Create your first invoice to see top customers</p></div>';
                    }

                    // Recent sales
                    const recentSalesDiv = document.getElementById('recentSales');
                    if (stats.daily_sales.length > 0) {
                        recentSalesDiv.innerHTML = stats.daily_sales.map(sale => 
                            `<div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                                <span>${formatDate(sale._id)}</span>
                                <span>${formatCurrency(sale.daily_sales)}</span>
                            </div>`
                        ).join('');
                    } else {
                        recentSalesDiv.innerHTML = '<div class="empty-state"><h3>No sales data</h3><p>Create invoices to see sales trends</p></div>';
                    }
                }

                if (itemsData.success) {
                    document.getElementById('totalItems').textContent = itemsData.items.length;
                }

            } catch (error) {
                console.error('Error loading dashboard:', error);
                showPopup('Error ‚ùå', 'Failed to load dashboard data. Please refresh the page.', 'alert');
            }
        }

        // Items functions
        async function loadItems() {
            try {
                const response = await fetch(`${API_BASE}/api/items`);
                const data = await response.json();

                if (data.success) {
                    currentItems = data.items;
                    displayItems(data.items);
                } else {
                    showPopup('Error ‚ùå', 'Error loading items: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error loading items:', error);
                showPopup('Error ‚ùå', 'Failed to load items. Please refresh the page.', 'alert');
            }
        }

        function displayItems(items) {
            const itemsTable = document.getElementById('itemsTable');
            
            if (items.length === 0) {
                itemsTable.innerHTML = '<div class="empty-state"><h3>No items found</h3><p>Add some items to your inventory</p></div>';
                return;
            }

            itemsTable.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Unit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    <td>${item.item_name}</td>
                                    <td>${formatCurrency(item.item_price)}</td>
                                    <td>${item.stock}</td>
                                    <td>${item.unit || '-'}</td>
                                    <td>
                                        <button onclick="updateItemStock('${item._id}', '${item.item_name}')" class="btn btn-warning">Update Stock</button>
                                        <button onclick="updateItemPrice('${item._id}', '${item.item_name}')" class="btn btn-primary">Update Price</button>
                                        <button onclick="deleteItem('${item._id}', '${item.item_name}')" class="btn btn-danger">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function searchItems() {
            const searchTerm = document.getElementById('itemSearch').value.trim();
            
            if (!searchTerm) {
                loadItems();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/items/search?q=${encodeURIComponent(searchTerm)}`);
                const data = await response.json();

                if (data.success) {
                    displayItems(data.items);
                } else {
                    showPopup('Error ‚ùå', 'Error searching items: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error searching items:', error);
                showPopup('Error ‚ùå', 'Failed to search items. Please try again.', 'alert');
            }
        }

        document.getElementById('addItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const itemName = document.getElementById('itemName').value.trim();
            const itemPrice = parseFloat(document.getElementById('itemPrice').value);
            const itemStock = parseInt(document.getElementById('itemStock').value);
            const itemUnit = document.getElementById('itemUnit').value;

            if (!itemName || itemPrice < 0 || itemStock < 0 || !itemUnit) {
                showPopup('Invalid Input ‚ö†Ô∏è', 'Please fill in all fields with valid values. Price and stock must be positive numbers and unit must be selected.', 'alert');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_name: itemName,
                        item_price: itemPrice,
                        stock: itemStock,
                        unit: itemUnit
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showPopup('Success! üéâ', `Item "${itemName}" added successfully to inventory!`, 'alert');
                    document.getElementById('addItemForm').reset();
                    loadItems();
                    loadItemsForInvoice();
                } else {
                    showPopup('Error ‚ùå', 'Error adding item: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error adding item:', error);
                showPopup('Error ‚ùå', 'Failed to add item. Please try again.', 'alert');
            }
        });

        async function updateItemStock(itemId, itemName) {
            showInputPopup(
                'Update Stock üì¶',
                `Enter additional stock for "${itemName}":`,
                'number',
                '10',
                (value) => processStockUpdate(itemId, itemName, value)
            );
        }
        
        async function processStockUpdate(itemId, itemName, additionalStock) {
            if (!additionalStock || additionalStock === '') return;

            const stock = parseInt(additionalStock);
            if (isNaN(stock) || stock < 0) {
                showPopup('Invalid Stock ‚ö†Ô∏è', 'Please enter a valid positive stock quantity.', 'alert');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/items/${itemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stock: stock,
                        update_type: 'add'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showPopup('Stock Updated! üì¶', data.message, 'alert');
                    loadItems();
                    loadItemsForInvoice();
                } else {
                    showPopup('Error ‚ùå', 'Error updating stock: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error updating stock:', error);
                showPopup('Error ‚ùå', 'Failed to update stock. Please try again.', 'alert');
            }
        }

        async function updateItemPrice(itemId, itemName) {
            showInputPopup(
                'Update Price üí∞',
                `Enter new price for "${itemName}" (‚Çπ):`,
                'number',
                '100.00',
                (value) => processPriceUpdate(itemId, itemName, value)
            );
        }
        
        async function processPriceUpdate(itemId, itemName, newPrice) {
            if (!newPrice || newPrice === '') return;

            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) {
                showPopup('Invalid Price ‚ö†Ô∏è', 'Please enter a valid price (must be greater than 0).', 'alert');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/items/${itemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_price: price
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showPopup('Price Updated! üí∞', data.message, 'alert');
                    loadItems();
                    loadItemsForInvoice();
                } else {
                    showPopup('Error ‚ùå', 'Error updating price: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error updating price:', error);
                showPopup('Error ‚ùå', 'Failed to update price. Please try again.', 'alert');
            }
        }

        async function deleteItem(itemId, itemName) {
            showPopup(
                'Delete Item? üóëÔ∏è',
                `Are you sure you want to permanently delete "${itemName}" from inventory?\n\nThis action cannot be undone!`,
                'confirm',
                () => processDeleteItem(itemId, itemName)
            );
        }
        
        async function processDeleteItem(itemId, itemName) {

            try {
                const response = await fetch(`${API_BASE}/api/items/${itemId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showPopup('Deleted! üóëÔ∏è', data.message, 'alert');
                    loadItems();
                    loadItemsForInvoice();
                } else {
                    showPopup('Error ‚ùå', 'Error deleting item: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showPopup('Error ‚ùå', 'Failed to delete item. Please try again.', 'alert');
            }
        }

        // Invoice functions
        async function loadItemsForInvoice() {
            try {
                const response = await fetch(`${API_BASE}/api/items`);
                const data = await response.json();

                if (data.success) {
                    const select = document.getElementById('invoiceItemSelect');
                    select.innerHTML = '<option value="">Select an item...</option>' +
                        data.items
                            .filter(item => item.stock > 0)
                            .map(item => `<option value="${item._id}" data-price="${item.item_price}" data-stock="${item.stock}" data-unit="${item.unit || 'pcs'}">${item.item_name} - ${formatCurrency(item.item_price)} (Stock: ${item.stock} ${item.unit || 'pcs'})</option>`)
                            .join('');
                } else {
                    showPopup('Error ‚ùå', 'Error loading items for invoice: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error loading items for invoice:', error);
                showPopup('Error ‚ùå', 'Failed to load items for invoice. Please refresh the page.', 'alert');
            }
        }

        document.getElementById('invoiceItemSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const stock = selectedOption.getAttribute('data-stock');
            document.getElementById('availableStock').value = stock || '';
        });

        function addItemToInvoice() {
            const select = document.getElementById('invoiceItemSelect');
            const quantity = parseInt(document.getElementById('invoiceQuantity').value);
            const availableStock = parseInt(document.getElementById('availableStock').value);

            if (!select.value) {
                showPopup('No Item Selected ‚ö†Ô∏è', 'Please select an item from the dropdown.', 'alert');
                return;
            }

            if (!quantity || quantity < 1) {
                showPopup('Invalid Quantity ‚ö†Ô∏è', 'Please enter a valid quantity (minimum 1).', 'alert');
                return;
            }

            if (quantity > availableStock) {
                showPopup('Insufficient Stock ‚ö†Ô∏è', `Not enough stock available. Only ${availableStock} units in stock.`, 'alert');
                return;
            }

            const selectedOption = select.options[select.selectedIndex];
            const itemId = select.value;
            const itemName = selectedOption.text.split(' - ')[0];
            const itemPrice = parseFloat(selectedOption.getAttribute('data-price'));
            const itemUnit = selectedOption.getAttribute('data-unit') || 'pcs';

            // Check if item already exists in invoice
            const existingItemIndex = invoiceItems.findIndex(item => item.item_id === itemId);
            if (existingItemIndex >= 0) {
                const totalQuantity = invoiceItems[existingItemIndex].quantity + quantity;
                if (totalQuantity > availableStock) {
                    showPopup('Stock Limit Exceeded ‚ö†Ô∏è', `Total quantity would exceed available stock. Only ${availableStock} units available.`, 'alert');
                    return;
                }
                invoiceItems[existingItemIndex].quantity = totalQuantity;
                invoiceItems[existingItemIndex].unit = itemUnit;
            } else {
                invoiceItems.push({
                    item_id: itemId,
                    name: itemName,
                    price: itemPrice,
                    quantity: quantity,
                    unit: itemUnit
                });
            }

            displayInvoiceItems();
            calculateInvoiceTotals();
            
            showPopup('Added! ‚úÖ', `${itemName} (${quantity} qty) added to invoice successfully.`, 'alert');

            // Reset form
            select.value = '';
            document.getElementById('invoiceQuantity').value = '1';
            document.getElementById('availableStock').value = '';
        }

        function displayInvoiceItems() {
            const container = document.getElementById('invoiceItemsList');
            
            if (invoiceItems.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No items added to invoice</p></div>';
                return;
            }

            container.innerHTML = invoiceItems.map((item, index) => `
                <div class="invoice-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 2px solid #e9ecef; margin-bottom: 10px; border-radius: 10px; background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="flex: 1;">
                        <strong style="color: #FF9933; font-size: 1.1em;">${item.name}</strong><br>
                        <span style="color: #666; font-size: 0.9em;">${item.quantity} ${item.unit || 'pcs'} √ó ${formatCurrency(item.price)} = <strong style="color: #138808;">${formatCurrency(item.quantity * item.price)}</strong></span>
                    </div>
                    <button onclick="confirmRemoveItemFromInvoice(${index})" 
                            class="btn btn-danger" 
                            style="background: linear-gradient(45deg, #FF6B6B, #FF8E53); border: none; 
                                   padding: 8px 15px; border-radius: 8px; color: white; font-weight: bold;
                                   transition: all 0.3s ease; box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(255, 107, 107, 0.4)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(255, 107, 107, 0.3)'">
                        üóëÔ∏è Remove
                    </button>
                </div>
            `).join('');
        }

        function confirmRemoveItemFromInvoice(index) {
            const item = invoiceItems[index];
            showPopup(
                'Remove Item? üóëÔ∏è', 
                `Are you sure you want to remove "${item.name}" from the invoice?`,
                'confirm',
                () => removeItemFromInvoice(index)
            );
        }
        
        function removeItemFromInvoice(index) {
            const item = invoiceItems[index];
            invoiceItems.splice(index, 1);
            displayInvoiceItems();
            calculateInvoiceTotals();
            showPopup('Removed! ‚úÖ', `"${item.name}" removed from invoice successfully.`, 'alert');
        }

        function calculateInvoiceTotals() {
            if (invoiceItems.length === 0) {
                document.getElementById('invoiceSummary').style.display = 'none';
                document.getElementById('generateBtn').disabled = true;
                return;
            }

            const subtotal = invoiceItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
            const tax = subtotal * (taxRate / 100);
            const discount = subtotal * (discountRate / 100);
            const total = subtotal + tax - discount;

            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('tax').textContent = formatCurrency(tax);
            document.getElementById('discount').textContent = formatCurrency(discount);
            document.getElementById('total').textContent = formatCurrency(total);

            document.getElementById('invoiceSummary').style.display = 'block';
            document.getElementById('generateBtn').disabled = false;
        }

        async function generateInvoice() {
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const customerAddress = document.getElementById('customerAddress').value.trim();
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;

            if (!customerName || !customerPhone || !customerAddress) {
                showPopup('Missing Information ‚ö†Ô∏è', 'Please fill in all customer information before generating invoice.', 'alert');
                return;
            }

            if (invoiceItems.length === 0) {
                showPopup('No Items ‚ö†Ô∏è', 'Please add items to the invoice before generating.', 'alert');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/invoices`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customer_name: customerName,
                        customer_address: customerAddress,
                        customer_number: customerPhone,
                        items: invoiceItems,
                        tax_rate: taxRate,
                        discount_rate: discountRate
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showPopup(
                        'Invoice Created! üìÑ', 
                        `Invoice #${data.invoice.invoice_id} created successfully! Would you like to download the PDF?`,
                        'confirm',
                        () => {
                            const sessionToken = localStorage.getItem('session_token');
                            window.open(`${API_BASE}/api/invoices/${data.invoice.invoice_id}/pdf?session_token=${sessionToken}`, '_blank');
                        }
                    );
                    clearInvoiceForm();
                } else {
                    showPopup('Error ‚ùå', 'Error creating invoice: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error creating invoice:', error);
                showPopup('Error ‚ùå', 'Failed to create invoice. Please try again.', 'alert');
            }
        }

        function clearInvoiceForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('taxRate').value = '0';
            document.getElementById('discountRate').value = '0';
            invoiceItems = [];
            displayInvoiceItems();
            calculateInvoiceTotals();
        }

        // Recalculate totals when tax/discount inputs change
        document.getElementById('taxRate').addEventListener('input', calculateInvoiceTotals);
        document.getElementById('discountRate').addEventListener('input', calculateInvoiceTotals);

        // Invoices functions
        async function loadInvoices() {
            try {
                const response = await fetch(`${API_BASE}/api/invoices`);
                const data = await response.json();

                if (data.success) {
                    displayInvoices(data.invoices);
                } else {
                    showPopup('Error ‚ùå', 'Error loading invoices: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error loading invoices:', error);
                showPopup('Error ‚ùå', 'Failed to load invoices. Please refresh the page.', 'alert');
            }
        }

        function displayInvoices(invoices) {
            const invoicesTable = document.getElementById('invoicesTable');
            
            if (invoices.length === 0) {
                invoicesTable.innerHTML = '<div class="empty-state"><h3>No invoices found</h3><p>Create your first invoice to get started</p></div>';
                return;
            }

            invoicesTable.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoices.map(invoice => `
                                <tr>
                                    <td>#${invoice.invoice_id}</td>
                                    <td>${invoice.customer_name}</td>
                                    <td>${formatDate(invoice.order_date)}</td>
                                    <td>${formatCurrency(invoice.total)}</td>
                                    <td>
                                        <button onclick="viewInvoiceDetails(${invoice.invoice_id})" class="btn btn-primary">View</button>
                                        <button onclick="downloadInvoicePDF(${invoice.invoice_id})" class="btn btn-success">Download PDF</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function viewInvoiceDetails(invoiceId) {
            try {
                const response = await fetch(`${API_BASE}/api/invoices/${invoiceId}`);
                const data = await response.json();

                if (data.success) {
                    const invoice = data.invoice;
                    const details = `
                        Invoice ID: #${invoice.invoice_id}
                        Customer: ${invoice.customer_name}
                        Address: ${invoice.customer_address}
                        Phone: ${invoice.customer_number}
                        Date: ${formatDate(invoice.order_date)}
                        
                        Items:
                        ${invoice.items.map(item => `${item.name} - ${item.quantity} x ${formatCurrency(item.price)} = ${formatCurrency(item.quantity * item.price)}`).join('\n')}
                        
                        Subtotal: ${formatCurrency(invoice.subtotal)}
                        Tax (${(invoice.tax_rate ?? 0).toFixed(2)}%): ${formatCurrency(invoice.tax)}
                        Discount (${(invoice.discount_rate ?? 0).toFixed(2)}%): ${formatCurrency(invoice.discount)}
                        Total: ${formatCurrency(invoice.total)}
                    `;
                    alert(details);
                } else {
                    showPopup('Error ‚ùå', 'Error loading invoice details: ' + data.error, 'alert');
                }
            } catch (error) {
                console.error('Error loading invoice details:', error);
                showPopup('Error ‚ùå', 'Failed to load invoice details. Please try again.', 'alert');
            }
        }

        function downloadInvoicePDF(invoiceId) {
            const sessionToken = localStorage.getItem('session_token');
            window.open(`${API_BASE}/api/invoices/${invoiceId}/pdf?session_token=${sessionToken}`, '_blank');
        }

        function searchInvoices() {
            const searchTerm = document.getElementById('invoiceSearch').value.trim().toLowerCase();
            
            if (!searchTerm) {
                loadInvoices();
                return;
            }

            // Simple client-side search (you could implement server-side search)
            const filteredInvoices = currentInvoices.filter(invoice => 
                invoice.customer_name.toLowerCase().includes(searchTerm) ||
                invoice.invoice_id.toString().includes(searchTerm)
            );
            
            displayInvoices(filteredInvoices);
        }

        // Initialize the application
        let currentInvoices = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            
            // Add search functionality with Enter key
            document.getElementById('itemSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchItems();
                }
            });
            
            document.getElementById('invoiceSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchInvoices();
                }
            });
        });
    </script>
    
    <!-- Footer -->
    <div style="text-align: center; padding: 30px 20px; margin-top: 40px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <p style="color: #138808; font-weight: bold; font-size: 1.2em; margin: 0 0 10px 0;">
            ‚ö° Kandhal Invoice System
        </p>
        <p style="color: #666; font-size: 0.9em; margin: 0;">
            Powered by Kandhal Technologies | Modern Invoice Management Solution
        </p>
    </div>
</body>
</html>
